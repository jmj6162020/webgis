{% extends "admin_base.html" %}

{% block title %}Edit User - Admin Dashboard{% endblock %}

{% block page_styles %}
<style>
/* Edit User Page Compact Styles */
.page-header {
    background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-primary-dark) 100%);
    color: var(--header-text);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px var(--shadow-color);
}

.page-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.page-header p {
    font-size: 0.9rem;
    margin: 0;
    opacity: 0.9;
}

.form-card {
    background: var(--surface-bg);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px var(--shadow-color);
    border: 1px solid var(--border-color);
}

.form-card h2 {
    color: var(--brand-primary);
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--brand-primary);
}

.form-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    font-size: 0.85rem;
}

.form-control, .form-select {
    border-radius: 6px;
    border: 1px solid var(--border-color);
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
    background: var(--surface-bg);
    color: var(--text-primary);
}

.form-control:focus, .form-select:focus {
    border-color: var(--brand-primary);
    box-shadow: 0 0 0 0.2rem rgba(139, 0, 0, 0.25);
}

.btn-save {
    background: var(--brand-primary);
    color: var(--header-text);
    border: none;
    padding: 0.5rem 1.25rem;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.btn-save:hover {
    background: var(--brand-primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(139, 0, 0, 0.3);
}

.btn-cancel {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.5rem 1.25rem;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    font-size: 0.85rem;
}

.btn-cancel:hover {
    background: #5c636a;
    color: white;
}

.form-check-input:checked {
    background-color: #8B0000;
    border-color: #8B0000;
}

.form-text {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.form-control-plaintext {
    font-size: 0.85rem;
    padding: 0.5rem !important;
}

.mb-3 {
    margin-bottom: 0.75rem !important;
}

.mb-4 {
    margin-bottom: 1rem !important;
}

.mt-4 {
    margin-top: 1rem !important;
}

@media (max-width: 768px) {
    .page-header h1 {
        font-size: 1.25rem;
    }
    
    .page-header p {
        font-size: 0.8rem;
    }
    
    .form-card {
        padding: 0.75rem;
    }
    
    .form-card h2 {
        font-size: 0.9rem;
    }
    
    .form-label {
        font-size: 0.8rem;
    }
    
    .form-control, .form-select {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
    }
    
    .btn-save, .btn-cancel {
        padding: 0.4rem 1rem;
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-3">
        {% for category, message in messages %}
            <div class="alert {% if category in ['success'] %}alert-success{% elif category in ['error','danger'] %}alert-danger{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}
{% endwith %}

<!-- Page Header -->
<div class="page-header">
    <h1><i class="bi bi-pencil-fill me-3"></i>Edit User</h1>
    <p>Update user information and settings</p>
</div>

{% if user %}
<!-- Edit User Form -->
<div class="form-card">
    <h2><i class="bi bi-person-fill me-2"></i>User Information</h2>
    <form method="POST" action="{{ url_for('admin_edit_user', user_id=user.user_id) }}">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="username" class="form-label">Username *</label>
                <input type="text" class="form-control" id="username" name="username" 
                       value="{{ user.username }}" required disabled>
                <input type="hidden" name="username" value="{{ user.username }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email Address *</label>
                <input type="email" class="form-control" id="email" name="email" 
                       value="{{ user.email }}" required disabled>
                <input type="hidden" name="email" value="{{ user.email }}">
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="full_name" class="form-label">Full Name *</label>
                <input type="text" class="form-control" id="full_name" name="full_name" 
                       placeholder="First Last" value="{{ (user.first_name ~ ' ' ~ user.last_name)|trim }}" required>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="role" class="form-label">Role *</label>
                <!-- Disabled to prevent role changes; hidden field preserves value for POST -->
                <select class="form-select" id="role" name="role_display" disabled>
                    <option value="">Select Role</option>
                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                    <option value="personnel" {% if user.role == 'personnel' %}selected{% endif %}>Personnel</option>
                    <option value="student" {% if user.role == 'student' %}selected{% endif %}>Student</option>
                </select>
                <input type="hidden" name="role" value="{{ user.role }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="school_id" class="form-label">School ID</label>
                <input type="text" class="form-control" id="school_id" name="school_id" 
                       value="{{ user.school_id or '' }}" 
                       placeholder="Required for students">
            </div>
        </div>
        
        <!-- Password Section -->
        <div class="mb-4">
            <h3 class="h5 text-muted mb-3">
                <i class="bi bi-shield-lock me-2"></i>Password Settings
            </h3>
            <div class="mb-3">
                <label for="new_password" class="form-label">New Password</label>
                <input type="password" class="form-control" id="new_password" name="new_password" 
                       placeholder="Leave blank to keep current password">
                <small class="form-text text-muted">
                    Leave this field blank if you don't want to change the password.
                </small>
            </div>
        </div>
        
        <!-- Status Section -->
        <div class="mb-4">
            <h3 class="h5 text-muted mb-3">
                <i class="bi bi-toggle-on me-2"></i>Account Status
            </h3>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                       {% if user.is_active %}checked{% endif %}>
                <label class="form-check-label" for="is_active">
                    Active Account
                </label>
                <small class="form-text text-muted d-block">
                    Uncheck to deactivate this user account.
                </small>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-flex gap-3 mt-4">
            <a href="{{ url_for('admin_manage_users') }}" class="btn-cancel">
                <i class="bi bi-arrow-left me-2"></i>Back to Users
            </a>
            <button type="submit" class="btn-save">
                <i class="bi bi-save-fill me-2"></i>Update User
            </button>
        </div>
    </form>
</div>

<!-- User Information Summary -->
<div class="form-card">
    <h2><i class="bi bi-info-circle-fill me-2"></i>Account Information</h2>
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">User ID</label>
                <div class="form-control-plaintext bg-light p-3 rounded border">
                    <i class="bi bi-hash me-2"></i>{{ user.user_id }}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Account Created</label>
                <div class="form-control-plaintext bg-light p-3 rounded border">
                    <i class="bi bi-calendar-event me-2"></i>
                    {{ user.created_at.strftime('%B %d, %Y at %I:%M %p') if user.created_at else 'N/A' }}
                </div>
            </div>
        </div>
    </div>
    {% if user.updated_at %}
    <div class="mb-3">
        <label class="form-label">Last Updated</label>
        <div class="form-control-plaintext bg-light p-3 rounded border">
            <i class="bi bi-arrow-clockwise me-2"></i>
            {{ user.updated_at.strftime('%B %d, %Y at %I:%M %p') }}
        </div>
    </div>
    {% endif %}
</div>

{% else %}
<div class="form-card">
    <div class="text-center py-5">
        <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
        <h3 class="mt-3">User Not Found</h3>
        <p class="text-muted">The requested user could not be found.</p>
        <a href="{{ url_for('admin_manage_users') }}" class="btn-cancel mt-3">
            <i class="bi bi-arrow-left me-2"></i>Back to Users
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password');
    
    // Check if password confirmation field exists and validate
    if (confirmPassword && newPassword) {
        if (newPassword !== confirmPassword.value) {
            e.preventDefault();
            alert('New password and confirm password do not match');
            return false;
        }
    }
    
    if (newPassword && newPassword.length < 8) {
        e.preventDefault();
        alert('Password must be at least 8 characters long');
        return false;
    }
    
    // Validate required fields
    const requiredFields = ['username', 'email', 'full_name', 'role'];
    for (const fieldName of requiredFields) {
        const field = document.getElementById(fieldName);
        if (!field.value.trim()) {
            e.preventDefault();
            alert(`Please fill in the ${fieldName.replace('_', ' ')} field`);
            return false;
        }
    }
});
</script>
{% endblock %}
