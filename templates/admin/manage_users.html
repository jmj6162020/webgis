{% extends "admin_base.html" %}

{% block title %}Manage Users - Admin Dashboard{% endblock %}

{% block page_styles %}
<style>
/* Manage Users Page Compact Styles */
.btn-add-user {
    background: var(--brand-primary);
    color: var(--header-text);
    border: none;
    padding: 0.5rem 1rem;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.btn-add-user:hover {
    background: var(--brand-primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px var(--shadow-color);
}

.role-badge {
    padding: 0.15rem 0.4rem;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 500;
}

.role-admin {
    background: #dc3545;
    color: white;
}

.role-personnel {
    background: #0d6efd;
    color: white;
}

.role-student {
    background: #198754;
    color: white;
}

.action-btn {
    padding: 0.15rem 0.4rem;
    border: none;
    border-radius: 4px;
    margin: 0 0.1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.75rem;
}

.btn-edit {
    background: #0d6efd;
    color: white;
}

.btn-edit:hover {
    background: #0b5ed7;
}

.btn-delete {
    background: #dc3545;
    color: white;
}

.btn-delete:hover {
    background: #bb2d3b;
}

.btn-block {
    background: #6c757d;
    color: white;
}
.btn-block:hover { background: #5a6268; }

.badge-compact {
    padding: 0.15rem 0.4rem;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 500;
}

/* Modal Styles */
.modal-content {
    background: var(--surface-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 24px var(--shadow-color);
}
.modal-header {
    background: var(--brand-primary);
    color: var(--header-text);
    padding: 1rem 1.5rem;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
}

.modal-body {
    padding: 1.5rem;
}

.modal-body .form-label {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.modal-body .form-control {
    border-radius: 6px;
    border: 1px solid var(--border-color);
    padding: 0.75rem;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    background: var(--surface-bg);
    color: var(--text-primary);
}

.modal-body .form-control:focus {
    border-color: var(--brand-primary);
    box-shadow: 0 0 0 0.2rem rgba(139, 0, 0, 0.25);
}

.modal-body .form-text {
    color: var(--text-muted);
}

.input-group .btn.btn-outline-secondary {
    background: var(--surface-alt-bg);
    color: var(--text-primary);
    border-color: var(--border-color);
}
.input-group .btn.btn-outline-secondary:hover {
    background: var(--surface-bg);
    color: var(--text-primary);
    border-color: var(--brand-primary);
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
}

.modal-footer .btn {
    padding: 0.75rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
}

.modal-body .mb-3 {
    margin-bottom: 1.25rem !important;
}

.modal-body .row {
    margin-bottom: 0.5rem;
}

.modal-body .col-md-6 {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
}

/* Form validation styles */
.form-control.is-valid {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.form-text {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
    margin-bottom: 0.5rem;
}

.text-danger {
    color: #dc3545 !important;
}

.form-check-label {
    font-size: 0.9rem;
    color: var(--text-primary);
    margin-left: 0.5rem;
}

.form-check {
    margin-bottom: 1rem;
}

.input-group .btn {
    border-color: var(--border-color);
    padding: 0.75rem 0.5rem;
     cursor: pointer;
    z-index: 10;
    position: relative;
}

.input-group .btn:hover {
    background-color: var(--surface-alt-bg);
    border-color: var(--border-color);
}

.input-group .btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(139, 0, 0, 0.25);
    border-color: #8B0000;
}

.input-group .btn i {
    pointer-events: none;
}

/* Filters UI */
.filters-section {
    border: 1px solid var(--border-color);
    border-radius: 10px;
    background: var(--surface-bg);
    padding: 1rem;
    box-shadow: 0 2px 8px var(--shadow-color);
}
.filters-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: .75rem;
}
.filters-title {
    display: flex;
    align-items: center;
    gap: .5rem;
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--brand-primary);
}
.btn-apply { background: var(--brand-primary); border: none; }
.btn-apply:hover { background: var(--brand-primary-dark); }

/* Dark mode table cells */
body.theme-dark .users-table {
    background-color: #000000;
    color: #ffffff;
}
body.theme-dark .users-table > :not(caption) > * > * {
    background-color: #000000;
    color: #ffffff;
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: none;
}

@media (max-width: 768px) {
    .page-header h1 {
        font-size: 1.5rem;
    }
    
    .page-header p {
        font-size: 0.85rem;
    }
    
    .action-buttons {
        margin-bottom: 1rem;
    }
    
    .users-table {
        font-size: 0.8rem;
    }
    
    .users-table th,
    .users-table td {
        padding: 0.5rem 0.25rem;
    }
    
    .action-btn {
        padding: 0.1rem 0.3rem;
        font-size: 0.7rem;
    }
    
    .role-badge,
    .badge-compact {
        font-size: 0.65rem;
        padding: 0.1rem 0.3rem;
    }
    
    /* Modal responsive adjustments */
    .modal-dialog {
        margin: 1rem;
        max-width: calc(100% - 2rem);
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-body .col-md-6 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    
    .modal-body .mb-3 {
        margin-bottom: 1rem !important;
    }
}

@media (max-width: 480px) {
    .page-header h1 {
        font-size: 1.25rem;
    }
    
    .btn-add-user {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
    }
    
    .users-table {
        font-size: 0.75rem;
    }
    
    .users-table th,
    .users-table td {
        padding: 0.4rem 0.2rem;
    }
}
</style>
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-3">
        {% for category, message in messages %}
            <div class="alert {% if category in ['success'] %}alert-success{% elif category in ['error','danger'] %}alert-danger{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}
{% endwith %}

<!-- Page Header -->
<div class="page-header">
    <h1><i class="bi bi-people-fill me-2"></i>Manage Users</h1>
    <p>Add, edit, and manage system users</p>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
    <button class="btn-add-user" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="bi bi-person-plus-fill me-1"></i>Add New User
    </button>
</div>

<!-- Filters -->
<div class="filters-section">
    <div class="filters-header">
        <h2 class="filters-title"><i class="bi bi-funnel-fill"></i> Filters</h2>
    </div>
    <form method="GET" action="{{ url_for('admin_manage_users') }}" class="row g-3">
        <div class="col-md-4">
            <label for="role" class="form-label">Role</label>
            <select id="role" name="role" class="form-select">
                <option value="" {% if not role_filter %}selected{% endif %}>All</option>
                <option value="admin" {% if role_filter=='admin' %}selected{% endif %}>Admin</option>
                <option value="personnel" {% if role_filter=='personnel' %}selected{% endif %}>Personnel</option>
                <option value="student" {% if role_filter=='student' %}selected{% endif %}>Student</option>
            </select>
        </div>
        <div class="col-md-8 d-flex align-items-end">
            <button type="submit" class="btn btn-primary btn-apply">
                <i class="bi bi-funnel me-2"></i>Apply
            </button>
            <a href="{{ url_for('admin_manage_users') }}" class="btn btn-secondary ms-2">
                <i class="bi bi-x-circle me-2"></i>Clear
            </a>
        </div>
    </form>
    {% if role_filter %}
    <div class="mt-2 text-muted small">Showing users with role: <strong>{{ role_filter|title }}</strong></div>
    {% endif %}
  </div>

<!-- Users Table -->
<div class="table-container mt-3">
    <table class="table table-hover mb-0 users-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Full Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if users %}
                {% for user in users %}
                <tr>
                    <td>{{ user.user_id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.first_name }} {{ user.last_name }}</td>
                    <td>
                        <span class="role-badge role-{{ user.role }}">
                            {{ user.role|title }}
                        </span>
                    </td>
                    <td>
                        <span class="badge-compact {% if user.is_active %}bg-success{% else %}bg-danger{% endif %} text-white">
                            {% if user.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn btn-edit js-edit-user" data-user-id="{{ user.user_id }}" title="Edit">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="action-btn btn-block js-toggle-user" data-user-id="{{ user.user_id }}" title="{% if user.is_active %}Block{% else %}Unblock{% endif %}">
                            <i class="bi {% if user.is_active %}bi-person-x-fill{% else %}bi-person-check-fill{% endif %}"></i>
                        </button>
                        <button class="action-btn btn-delete js-delete-user" data-user-id="{{ user.user_id }}" title="Delete (deactivate)">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="text-muted mt-3">No users found</p>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm" method="POST" action="{{ url_for('admin_add_user') }}">
                    {{ form.hidden_tag() if form }}
                    
                    <!-- Basic Information Section -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="username" name="username" required 
                                       placeholder="Enter username" minlength="3" maxlength="50">
                                <div class="form-text">3-50 characters, alphanumeric only</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required 
                                       placeholder="user@example.com">
                                <div class="form-text">Valid email address required</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Name Section -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="first_name" name="first_name" required 
                                       placeholder="Enter first name" maxlength="50">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="last_name" name="last_name" required 
                                       placeholder="Enter last name" maxlength="50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Role and Status Section -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modal_role" class="form-label">Role <span class="text-danger">*</span></label>
                                <select class="form-control" id="modal_role" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin - Full system access</option>
                                    <option value="personnel">Personnel - Verification access</option>
                                    <option value="student">Student - Submission access</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modal_school_id" class="form-label">School ID</label>
                                <input type="text" class="form-control" id="modal_school_id" name="school_id" 
                                       placeholder="Student ID (if applicable)" maxlength="20">
                                <div class="form-text">Required for students</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Password Section -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password" name="password" required 
                                           placeholder="Enter password" minlength="6">
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="bi bi-eye" id="passwordIcon"></i>
                                    </button>
                                </div>
                                <div class="form-text">Minimum 6 characters</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required 
                                           placeholder="Confirm password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="bi bi-eye" id="confirmPasswordIcon"></i>
                                    </button>
                                </div>
                                <div class="form-text">Must match password</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addUserForm" class="btn btn-primary" style="background: #8B0000; border: none;">Add User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Password toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    // Password toggle functionality
    function togglePasswordVisibility(toggleBtn, inputField, iconElement) {
        if (!toggleBtn || !inputField || !iconElement) return;
        
        toggleBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const isPassword = inputField.type === 'password';
            inputField.type = isPassword ? 'text' : 'password';
            
            if (isPassword) {
                iconElement.className = 'bi bi-eye-slash';
            } else {
                iconElement.className = 'bi bi-eye';
            }
        };
    }
    
    // Initialize password toggles
    togglePasswordVisibility(
        document.getElementById('togglePassword'),
        document.getElementById('password'),
        document.getElementById('passwordIcon')
    );
    
    togglePasswordVisibility(
        document.getElementById('toggleConfirmPassword'),
        document.getElementById('confirm_password'),
        document.getElementById('confirmPasswordIcon')
    );
    
    // Form validation
    const form = document.getElementById('addUserForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate password match
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            // Validate username format
            const username = document.getElementById('username').value;
            const usernameRegex = /^[a-zA-Z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                alert('Username can only contain letters, numbers, and underscores!');
                return;
            }
            
            // Validate school ID for students
            const role = document.getElementById('modal_role')?.value || '';
            const schoolId = document.getElementById('modal_school_id')?.value || '';
            
            if (role === 'student' && !schoolId.trim()) {
                alert('School ID is required for students!');
                return;
            }
            
            // If all validations pass, submit the form
            form.submit();
        });
    }
    
    // Real-time password confirmation validation
    const confirmPasswordInput = document.getElementById('confirm_password');
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && password !== confirmPassword) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else if (confirmPassword && password === confirmPassword) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
            }
        });
    }
    
    // Username validation
    const usernameInput = document.getElementById('username');
    if (usernameInput) {
        usernameInput.addEventListener('input', function() {
            const username = this.value;
            const usernameRegex = /^[a-zA-Z0-9_]+$/;
            
            if (username && !usernameRegex.test(username)) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else if (username && username.length >= 3) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
            }
        });
    }
    
    // Role change handler
    const roleSelect = document.getElementById('modal_role');
    const schoolIdField = document.getElementById('modal_school_id');
    if (roleSelect && schoolIdField) {
        roleSelect.addEventListener('change', function() {
            if (this.value === 'student') {
                schoolIdField.required = true;
                schoolIdField.parentElement.querySelector('.form-text').textContent = 'Required for students';
            } else {
                schoolIdField.required = false;
                schoolIdField.parentElement.querySelector('.form-text').textContent = 'Optional';
            }
        });
    }
});

function editUser(userId) {
    // Implement edit user functionality
    console.log('Edit user function called with userId:', userId);
    console.log('Type of userId:', typeof userId);
    console.log('URL being navigated to:', `/admin/edit-user/${userId}`);
    
    if (!userId || userId === 'undefined') {
        alert('Error: Invalid user ID');
        return;
    }
    
    // Redirect to edit page
    window.location.href = `/admin/edit-user/${userId}`;
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        fetch(`/admin/delete-user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name=csrf_token]')?.value || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Error deleting user');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
    }
}

// Attach click handlers
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.js-edit-user').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-user-id');
            if (id) editUser(id);
        });
    });
    document.querySelectorAll('.js-delete-user').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-user-id');
            if (id) deleteUser(id);
        });
    });
    document.querySelectorAll('.js-toggle-user').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-user-id');
            if (!id) return;
            fetch(`/admin/toggle-user/${id}`, { method: 'POST' })
                .then(() => window.location.reload())
                .catch(() => alert('Error toggling user status'));
        });
    });
});
</script>
{% endblock %}
