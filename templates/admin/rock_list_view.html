{% extends "admin_base.html" %}

{% block title %}Rock List View - Admin Dashboard{% endblock %}

{% block page_styles %}
<style>
/* Rock List View Page Specific Styles */
.search-filters {
    background: var(--surface-bg);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px var(--shadow-color);
    border: 1px solid var(--border-color);
}

/* Status Tabs */
.status-tabs {
    background: var(--surface-bg);
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px var(--shadow-color);
    overflow: hidden;
}

.nav-tabs {
    border-bottom: none;
    margin: 0;
    padding: 0.5rem 0.5rem 0 0.5rem;
}

.nav-tabs .nav-link {
    border: none;
    border-radius: 8px 8px 0 0;
    padding: 1rem 2rem;
    font-weight: 600;
    color: var(--text-muted);
    background: var(--surface-alt-bg);
    transition: all 0.3s ease;
    margin-right: 0.5rem;
    margin-bottom: 0;
}

.nav-tabs .nav-link:hover {
    border-color: transparent;
    background: var(--surface-bg);
    color: var(--brand-primary);
}

.nav-tabs .nav-link.active {
    background: var(--brand-primary);
    color: var(--header-text);
    border-color: var(--brand-primary);
}

.tab-content {
    padding: 0;
}

.tab-pane {
    padding: 0;
}

/* Status Section Headers */
.status-section-header {
    background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-primary-dark) 100%);
    color: var(--header-text);
    padding: 0.75rem 1.5rem;
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.status-section-header .btn-group {
    margin-left: auto;
}

.status-section-header .dropdown-menu {
    min-width: 180px;
}

.status-section-header.verified {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
}

.status-section-header.pending {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: #000;
}

.status-section-header.rejected {
    background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
}

.status-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 700;
}

.status-count.pending {
    background: rgba(0, 0, 0, 0.2);
}

.status-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 500;
}

.action-btns {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    padding: 0.25rem;
}

.btn-view {
    background: #0d6efd;
    color: white;
    border: none;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    transition: all 0.2s ease;
    font-size: 0.8rem;
    font-weight: 500;
}

.btn-view:hover {
    background: #0b5ed7;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
}

.btn-archive {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.8rem;
    font-weight: 500;
}

.btn-archive:hover {
    background: #5c636a;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
}

/* Compact Table Styling */
.table-container {
    margin-top: 0.5rem;
}

.table-container table {
    border-spacing: 0;
    border-collapse: separate;
    font-size: 0.9rem;
}

.table-container thead th {
    padding: 0.5rem 0.75rem !important;
    font-size: 0.85rem;
    font-weight: 600;
}

.table-container tbody td {
    padding: 0.5rem 0.75rem !important;
    vertical-align: middle;
}

.table-container tbody tr {
    transition: background-color 0.2s ease;
}

.table-container tbody tr:hover {
    background-color: var(--surface-alt-bg);
}

/* Better spacing for empty states */
.text-center.py-5 {
    padding: 3rem 1rem !important;
}

/* Improved mobile spacing */

/* Dark mode: full black table cells for readability */
body.theme-dark .table-container table {
    background-color: #000000;
    color: #ffffff;
}
body.theme-dark .table-container table > :not(caption) > * > * {
    background-color: #000000;
    color: #ffffff;
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: none;
}

@media (max-width: 768px) {
    .nav-tabs .nav-link {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }
    
    .status-section-header {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    
    .action-btns {
        gap: 0.25rem;
        padding: 0.25rem;
    }
    
    .btn-view, .btn-archive {
        padding: 0.2rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .table-container thead th,
    .table-container tbody td {
        padding: 0.4rem 0.5rem !important;
        font-size: 0.8rem;
    }
}

@media (max-width: 768px) {
    .page-header h1 {
        font-size: 2rem;
    }
    
    .rocks-table {
        font-size: 0.875rem;
    }
    
    .rocks-table th, .rocks-table td {
        padding: 0.75rem 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-3">
        {% for category, message in messages %}
            <div class="alert {% if category in ['success'] %}alert-success{% elif category in ['error','danger'] %}alert-danger{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}
{% endwith %}

<!-- Page Header -->
<div class="page-header">
    <h1><i class="bi bi-list-ul me-2"></i>Rock List View</h1>
    <p>Browse and manage all rock samples</p>
</div>

<!-- Search and Filters -->
<div class="search-filters">
    <form method="GET" action="{{ url_for('admin_rock_list') }}" class="row g-3 form-compact">
        <div class="col-md-6">
            <label for="search" class="form-label">Search</label>
            <input type="text" class="form-control" id="search" name="search" 
                   placeholder="Search by rock ID, type, location, or student name" 
                   value="{{ search_query or '' }}">
        </div>
        <div class="col-md-4">
            <label for="rock_type" class="form-label">Rock Type</label>
            <select class="form-select" id="rock_type" name="rock_type">
                <option value="">All Types</option>
                <option value="Igneous Rock" {% if rock_type_filter == 'Igneous Rock' %}selected{% endif %}>Igneous Rock</option>
                <option value="Sedimentary Rock" {% if rock_type_filter == 'Sedimentary Rock' %}selected{% endif %}>Sedimentary Rock</option>
                <option value="Metamorphic Rock" {% if rock_type_filter == 'Metamorphic Rock' %}selected{% endif %}>Metamorphic Rock</option>
            </select>
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-sm me-2" style="background: #8B0000; color: white; border: none;">
                <i class="bi bi-search me-1"></i>Search & Filter
            </button>
            <a href="{{ url_for('admin_rock_list') }}" class="btn btn-secondary btn-sm">
                <i class="bi bi-x-circle me-1"></i>Clear Filters
            </a>
        </div>
    </form>
</div>

<script>
function exportData(format, status) {
    // Get current filter values from the form
    const search = document.getElementById('search').value || '';
    const rockType = document.getElementById('rock_type').value || '';
    
    // Build query string
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (rockType) params.append('rock_type', rockType);
    if (status) params.append('status', status);
    
    // Build export URL
    const baseUrl = format === 'csv' 
        ? '{{ url_for("admin_export_rocks_csv") }}'
        : '{{ url_for("admin_export_rocks_excel") }}';
    
    const url = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
    
    // Trigger download
    window.location.href = url;
}
</script>

<!-- Status Tabs -->
<div class="status-tabs">
    <ul class="nav nav-tabs" id="statusTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                <i class="bi bi-list-ul me-2"></i>All Samples
                <span class="status-count">{{ rocks|length if rocks else 0 }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="verified-tab" data-bs-toggle="tab" data-bs-target="#verified" type="button" role="tab">
                <i class="bi bi-check-circle-fill me-2"></i>Verified
                <span class="status-count">{{ rocks|selectattr('status', 'equalto', 'verified')|list|length if rocks else 0 }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                <i class="bi bi-clock-fill me-2"></i>Pending
                <span class="status-count">{{ rocks|selectattr('status', 'equalto', 'pending')|list|length if rocks else 0 }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                <i class="bi bi-x-circle-fill me-2"></i>Rejected
                <span class="status-count">{{ rocks|selectattr('status', 'equalto', 'rejected')|list|length if rocks else 0 }}</span>
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="statusTabsContent">
        <!-- All Samples Tab -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            <div class="status-section-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span><i class="bi bi-list-ul me-2"></i>All Rock Samples</span>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span class="status-count">{{ rocks|length if rocks else 0 }} Total</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style="background: #198754; border: none;">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportData('csv', ''); return false;">
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export as CSV
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportData('excel', ''); return false;">
                                    <i class="bi bi-file-earmark-excel me-2"></i>Export as Excel
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="table-container">
    <div class="table-responsive">
                    <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Rock ID</th>
                    <th>Type</th>
                    <th>Location</th>
                    <th>Student ID</th>
                    <th>Submitted By</th>
                    <th>Date Submitted</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if rocks %}
                    {% for rock in rocks %}
                    <tr>
                        <td>{{ rock.sample_id }}</td>
                        <td>{{ rock.rock_id }}</td>
                        <td>{{ rock.rock_type }}</td>
                        <td>{{ rock.location_name }}</td>
                        <td>{{ rock.student_id or 'N/A' }}</td>
                        <td>{{ rock.student_name or 'Unknown' }}</td>
                        <td>{{ rock.created_at.strftime('%Y-%m-%d') if rock.created_at else '' }}</td>
                        <td>
                            <span class="status-badge badge 
                                {% if rock.status == 'verified' %}bg-success
                                {% elif rock.status == 'pending' %}bg-warning text-dark
                                {% else %}bg-danger{% endif %}">
                                {{ rock.status|title }}
                            </span>
                        </td>
                        <td>
                            <div class="action-btns">
                                <a href="{{ url_for('admin_rock_detail', sample_id=rock.sample_id) }}" class="btn-view">
                                    <i class="bi bi-eye-fill me-1"></i>View
                                </a>
                                <button class="btn-archive" onclick="archiveRock({{ rock.sample_id }})">
                                    <i class="bi bi-archive-fill me-1"></i>Archive
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <p class="text-muted mt-3">No rocks found</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
                </div>
            </div>
        </div>

        <!-- Verified Samples Tab -->
        <div class="tab-pane fade" id="verified" role="tabpanel">
            <div class="status-section-header verified" style="display: flex; justify-content: space-between; align-items: center;">
                <span><i class="bi bi-check-circle-fill me-2"></i>Verified Rock Samples</span>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span class="status-count">{{ rocks|selectattr('status', 'equalto', 'verified')|list|length if rocks else 0 }} Verified</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style="background: #198754; border: none;">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportData('csv', 'verified'); return false;">
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export as CSV
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportData('excel', 'verified'); return false;">
                                    <i class="bi bi-file-earmark-excel me-2"></i>Export as Excel
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Rock ID</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Student ID</th>
                                <th>Submitted By</th>
                                <th>Date Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set verified_rocks = rocks|selectattr('status', 'equalto', 'verified')|list if rocks else [] %}
                            {% if verified_rocks %}
                                {% for rock in verified_rocks %}
                                <tr>
                                    <td>{{ rock.sample_id }}</td>
                                    <td>{{ rock.rock_id }}</td>
                                    <td>{{ rock.rock_type }}</td>
                                    <td>{{ rock.location_name }}</td>
                                    <td>{{ rock.student_id or 'N/A' }}</td>
                                    <td>{{ rock.student_name or 'Unknown' }}</td>
                                    <td>{{ rock.created_at.strftime('%Y-%m-%d') if rock.created_at else '' }}</td>
                                    <td>
                                        <div class="action-btns">
                                            <a href="{{ url_for('admin_rock_detail', sample_id=rock.sample_id) }}" class="btn-view">
                                                <i class="bi bi-eye-fill me-1"></i>View
                                            </a>
                                            <button class="btn-archive" onclick="archiveRock({{ rock.sample_id }})">
                                                <i class="bi bi-archive-fill me-1"></i>Archive
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center py-5">
                                        <i class="bi bi-check-circle display-4 text-success"></i>
                                        <p class="text-muted mt-3">No verified samples found</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pending Samples Tab -->
        <div class="tab-pane fade" id="pending" role="tabpanel">
            <div class="status-section-header pending" style="display: flex; justify-content: space-between; align-items: center;">
                <span><i class="bi bi-clock-fill me-2"></i>Pending Review Samples</span>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span class="status-count pending">{{ rocks|selectattr('status', 'equalto', 'pending')|list|length if rocks else 0 }} Pending</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style="background: #ffc107; border: none; color: #000;">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportData('csv', 'pending'); return false;">
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export as CSV
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportData('excel', 'pending'); return false;">
                                    <i class="bi bi-file-earmark-excel me-2"></i>Export as Excel
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Rock ID</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Student ID</th>
                                <th>Submitted By</th>
                                <th>Date Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set pending_rocks = rocks|selectattr('status', 'equalto', 'pending')|list if rocks else [] %}
                            {% if pending_rocks %}
                                {% for rock in pending_rocks %}
                                <tr>
                                    <td>{{ rock.sample_id }}</td>
                                    <td>{{ rock.rock_id }}</td>
                                    <td>{{ rock.rock_type }}</td>
                                    <td>{{ rock.location_name }}</td>
                                    <td>{{ rock.student_id or 'N/A' }}</td>
                                    <td>{{ rock.student_name or 'Unknown' }}</td>
                                    <td>{{ rock.created_at.strftime('%Y-%m-%d') if rock.created_at else '' }}</td>
                                    <td>
                                        <div class="action-btns">
                                            <a href="{{ url_for('admin_rock_detail', sample_id=rock.sample_id) }}" class="btn-view">
                                                <i class="bi bi-eye-fill me-1"></i>View
                                            </a>
                                            <button class="btn-archive" onclick="archiveRock({{ rock.sample_id }})">
                                                <i class="bi bi-archive-fill me-1"></i>Archive
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center py-5">
                                        <i class="bi bi-clock display-4 text-warning"></i>
                                        <p class="text-muted mt-3">No pending samples found</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Rejected Samples Tab -->
        <div class="tab-pane fade" id="rejected" role="tabpanel">
            <div class="status-section-header rejected" style="display: flex; justify-content: space-between; align-items: center;">
                <span><i class="bi bi-x-circle-fill me-2"></i>Rejected Rock Samples</span>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span class="status-count">{{ rocks|selectattr('status', 'equalto', 'rejected')|list|length if rocks else 0 }} Rejected</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style="background: #dc3545; border: none;">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportData('csv', 'rejected'); return false;">
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export as CSV
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportData('excel', 'rejected'); return false;">
                                    <i class="bi bi-file-earmark-excel me-2"></i>Export as Excel
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Rock ID</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Student ID</th>
                                <th>Submitted By</th>
                                <th>Date Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set rejected_rocks = rocks|selectattr('status', 'equalto', 'rejected')|list if rocks else [] %}
                            {% if rejected_rocks %}
                                {% for rock in rejected_rocks %}
                                <tr>
                                    <td>{{ rock.sample_id }}</td>
                                    <td>{{ rock.rock_id }}</td>
                                    <td>{{ rock.rock_type }}</td>
                                    <td>{{ rock.location_name }}</td>
                                    <td>{{ rock.student_id or 'N/A' }}</td>
                                    <td>{{ rock.student_name or 'Unknown' }}</td>
                                    <td>{{ rock.created_at.strftime('%Y-%m-%d') if rock.created_at else '' }}</td>
                                    <td>
                                        <div class="action-btns">
                                            <a href="{{ url_for('admin_rock_detail', sample_id=rock.sample_id) }}" class="btn-view">
                                                <i class="bi bi-eye-fill me-1"></i>View
                                            </a>
                                            <button class="btn-archive" onclick="archiveRock({{ rock.sample_id }})">
                                                <i class="bi bi-archive-fill me-1"></i>Archive
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center py-5">
                                        <i class="bi bi-x-circle display-4 text-danger"></i>
                                        <p class="text-muted mt-3">No rejected samples found</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if pagination %}
<div class="d-flex justify-content-center mt-4">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin_rock_list', page=pagination.prev_num) }}">Previous</a>
            </li>
            {% endif %}
            
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('admin_rock_list', page=page_num) }}">{{ page_num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin_rock_list', page=pagination.next_num) }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function archiveRock(rockId) {
    if (confirm('Are you sure you want to archive this rock?')) {
        // Create form data
        const formData = new FormData();
        formData.append('reason', 'Archived by admin');
        
        fetch(`/admin/archive-rock/${rockId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                throw new Error(`Archive request failed with status ${response.status}`);
            }
        })
        .catch(error => {
            console.error('Error archiving rock:', error);
            alert('Error archiving rock: ' + error.message);
        });
    }
}

// Enhanced search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search');
    const rockTypeSelect = document.getElementById('rock_type');
    const searchForm = document.querySelector('form');
    
    // Auto-submit on rock type change
    rockTypeSelect.addEventListener('change', function() {
        console.log('Rock type changed to:', this.value);
        searchForm.submit();
    });
    
    // Clear search on Escape key
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchInput.value = '';
            rockTypeSelect.value = '';
            searchForm.submit();
        }
    });
    
    // Show search results count
    const totalRocks = {{ rocks|length if rocks else 0 }};
    const searchQuery = '{{ search_query or "" }}';
    const rockTypeFilter = '{{ rock_type_filter or "" }}';
    
    console.log('Search query:', searchQuery);
    console.log('Rock type filter:', rockTypeFilter);
    console.log('Total rocks:', totalRocks);
    
    if (searchQuery || rockTypeFilter) {
        const resultsText = document.createElement('div');
        resultsText.className = 'alert alert-info mt-2';
        
        let message = `Showing ${totalRocks} result${totalRocks !== 1 ? 's' : ''}`;
        
        if (searchQuery && rockTypeFilter) {
            message += ` for "${searchQuery}" filtered by ${rockTypeFilter}`;
        } else if (searchQuery) {
            message += ` for "${searchQuery}"`;
        } else if (rockTypeFilter) {
            message += ` filtered by ${rockTypeFilter}`;
        }
        
        resultsText.innerHTML = `<i class="bi bi-info-circle me-2"></i>${message}`;
        searchForm.parentNode.insertBefore(resultsText, searchForm.nextSibling);
    }
    
    // Ensure form maintains both search and rock type when submitting
    searchForm.addEventListener('submit', function(e) {
        console.log('Form submitted with search:', searchInput.value, 'rock type:', rockTypeSelect.value);
    });
});
</script>
{% endblock %}
