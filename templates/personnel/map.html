{% extends "personnel_base.html" %}

{% block title %}Interactive Map - Personnel Dashboard{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* Compact page header */
    .page-header {
        background: var(--brand-primary);
        color: var(--header-text);
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px var(--shadow-color);
    }

    .page-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    .page-header p {
        font-size: 0.9rem;
        margin: 0;
        opacity: 0.9;
    }

    /* Compact map legend */
    .map-legend {
        background: var(--surface-bg);
        padding: 0.75rem;
        border-radius: 6px;
        box-shadow: 0 2px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .map-legend h5 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
        font-size: 0.85rem;
    }

    .legend-marker {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 0.5rem;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .marker-specimen {
        background-color: #9933cc;
    }
    .legend-specimen-igneous { background-color: #9933cc; }      /* purple */
    .legend-specimen-sedimentary { background-color: #dc2626; }  /* red */
    .legend-specimen-metamorphic { background-color: #16a34a; }  /* green */

    /* Map controls */
    .map-controls {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 1rem;
        background: var(--surface-bg);
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 2px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .map-controls .control-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 180px;
    }

    .map-controls .control-item label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0;
    }

    .map-controls select, .map-controls input {
        min-width: 180px;
        max-width: 100%;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--surface-bg);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .map-controls .btn-clear-filters {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s ease;
        align-self: flex-end;
        margin-top: 1.5rem;
    }

    .map-controls .btn-clear-filters:hover {
        background: #5a6268;
    }

    .specimen-badge {
        background: #e6f3ff;
        color: #004a99;
        border: 1px solid #b3d7ff;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    /* Compact map container */
    .map-container {
        height: 500px;
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 1rem;
        overflow: hidden;
        background: var(--surface-bg);
    }

    #map {
        height: 500px;
        width: 100%;
        border-radius: 6px;
        overflow: hidden;
        background: var(--surface-bg);
    }

    /* Compact info section */
    .info-section {
        background: var(--surface-bg);
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 2px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
    }

    .info-section h3 {
        color: var(--brand-primary);
        font-weight: 600;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
    }

    .map-popup-images {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .map-popup-image-block {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.65rem;
        color: #555555;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .map-popup-image {
        width: 64px;
        height: 64px;
        border-radius: 6px;
        object-fit: cover;
        border: 1px solid rgba(0, 0, 0, 0.2);
        background: #f8f9fa;
    }

    /* Dark mode tweaks for Leaflet UI */
    body.theme-dark .map-legend,
    body.theme-dark .map-controls,
    body.theme-dark .info-section {
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.45);
    }

    body.theme-dark .leaflet-control,
    body.theme-dark .leaflet-control a {
        background-color: rgba(17, 24, 39, 0.9);
        color: #e2e8f0;
        border-color: rgba(148, 163, 184, 0.35);
    }

    body.theme-dark .leaflet-popup-content-wrapper,
    body.theme-dark .leaflet-popup-tip {
        background: rgba(17, 24, 39, 0.95);
        color: #e2e8f0;
        border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .info-section ol {
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .info-section li {
        margin-bottom: 0.25rem;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 1.25rem;
        }
        
        .page-header p {
            font-size: 0.8rem;
        }
        
        .map-controls {
            flex-direction: column;
        }
        
        .map-controls .control-item {
            width: 100%;
            min-width: 100%;
        }
        
        .map-controls select, .map-controls input {
            width: 100%;
            min-width: 100%;
        }
        
        .map-controls .btn-clear-filters {
            width: 100%;
            align-self: stretch;
            margin-top: 0.5rem;
        }
        
        #map {
            height: 350px;
        }
        
        .map-container {
            height: 350px;
        }
    }
</style>
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-3">
        {% for category, message in messages %}
            <div class="alert {% if category in ['success'] %}alert-success{% elif category in ['error','danger'] %}alert-danger{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}
{% endwith %}

<!-- Page Header -->
<div class="page-header">
    <h1><i class="bi bi-map-fill me-2"></i>Interactive Map</h1>
    <p>View and inspect all rock sample locations</p>
</div>

<!-- Map Legend -->
<div class="map-legend">
    <h5 class="fw-bold mb-2">Map Legend</h5>
    <div class="row">
        <div class="col-12">
            <div class="legend-item" style="gap: 0.75rem; flex-wrap: wrap;">
                <span class="me-1">Rock Specimens:</span>
                <div class="legend-item"><div class="legend-marker legend-specimen-igneous"></div><span>Igneous</span></div>
                <div class="legend-item"><div class="legend-marker legend-specimen-sedimentary"></div><span>Sedimentary</span></div>
                <div class="legend-item"><div class="legend-marker legend-specimen-metamorphic"></div><span>Metamorphic</span></div>
            </div>
        </div>
    </div>
  </div>

<!-- Compact Controls -->
<div class="map-controls">
    <div class="control-item">
        <label for="rock-id-filter"><strong>Rock ID:</strong></label>
        <input type="text" id="rock-id-filter" placeholder="Search by Rock ID (e.g., IG-Gamma-03)" />
    </div>
    <div class="control-item">
        <label for="rock-type-filter"><strong>Rock Type:</strong></label>
        <select id="rock-type-filter">
            <option value="">All Types</option>
            <option value="Igneous Rock">Igneous Rock</option>
            <option value="Sedimentary Rock">Sedimentary Rock</option>
            <option value="Metamorphic Rock">Metamorphic Rock</option>
        </select>
    </div>
    <div class="control-item">
        <label for="city-select"><strong>City/Municipality:</strong></label>
        <select id="city-select" aria-label="Select city or municipality"></select>
    </div>
    <div class="control-item">
        <label class="text-muted"><strong>Results:</strong></label>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span id="selected-city-name" class="fw-semibold">All cities</span>
            <span class="specimen-badge" title="Number of specimens">
            <span id="specimen-count">â€”</span>
        </span>
        </div>
    </div>
    <div class="control-item">
        <button type="button" class="btn-clear-filters" onclick="clearAllFilters()">
            <i class="bi bi-x-circle me-1"></i>Clear Filters
        </button>
    </div>
</div>

<!-- Map Container -->
<div class="map-container">
    <div id="map"></div>
</div>

<!-- Navigation Info -->
<div class="info-section">
    <h3>Map Navigation & Filters</h3>
    <ol>
        <li><strong>View Rock Specimens:</strong> All rock samples are displayed on the map</li>
        <li><strong>Search Filters:</strong> Use the filters above to search by Rock ID, Rock Type, or City/Municipality</li>
        <li><strong>Combined Filters:</strong> Multiple filters can be used together for precise searches</li>
        <li><strong>Specimen Details:</strong> Click on any marker to view detailed information about the rock</li>
        <li><strong>Clear Filters:</strong> Use the "Clear Filters" button to reset all search criteria</li>
    </ol>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Map Data (safe JSON) -->
<script id="map-data" type="application/json">{"cities": {{ cities | tojson }}, "rocks": {{ rocks | tojson }}}</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse data
        const rawDataEl = document.getElementById('map-data');
        const parsed = rawDataEl ? JSON.parse(rawDataEl.textContent) : { cities: [], rocks: [] };
        const citiesData = Array.isArray(parsed.cities) ? parsed.cities : [];
        const rocksData = Array.isArray(parsed.rocks) ? parsed.rocks : [];

        // Map and layers
        let map;
        const specimenLayer = L.layerGroup();
        const cityNameToData = new Map(citiesData.map(c => [c.location_name, c]));
        
        function initializeMap() {
            console.log('Initializing map with all rocks...');
            
            // Check if map element exists
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Map element not found!');
                return;
            }
            
            try {
                // Remove existing map if it exists
                if (map) {
                    map.remove();
                }
                
                // Create new map
                map = L.map('map', {
                    center: [8.9475, 125.5406],
                    zoom: 6,
                    zoomControl: true,
                    scrollWheelZoom: true,
                    dragging: true
                });
                
                console.log('Map object created');
    
                // Add OpenStreetMap tiles
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                });
                
                tileLayer.addTo(map);
                console.log('Tiles added');
                
                // Add specimen layer and render all rocks
                specimenLayer.addTo(map);
                populateCityDropdown();
                setupFilters();
                renderAllSpecimens();
                
                // Force refresh
                setTimeout(() => {
                    map.invalidateSize();
                    console.log('Map size invalidated');
                }, 100);
        
            } catch (error) {
                console.log(`Error: ${error.message}`);
            }
        }

        // Unified filtering function
        function getFilteredSpecimens() {
            const rockIdFilter = document.getElementById('rock-id-filter')?.value.trim().toLowerCase() || '';
            const rockTypeFilter = document.getElementById('rock-type-filter')?.value || '';
            const cityFilter = document.getElementById('city-select')?.value || '';
            
            return rocksData.filter(rock => {
                // Filter by coordinates (must have valid coordinates)
                if (rock.latitude == null || rock.longitude == null) return false;
                
                // Filter by Rock ID (case-insensitive partial match)
                if (rockIdFilter && !(rock.rock_id || '').toLowerCase().includes(rockIdFilter)) {
                    return false;
                }
                
                // Filter by Rock Type (exact match)
                if (rockTypeFilter && rock.rock_type !== rockTypeFilter) {
                    return false;
                }
                
                // Filter by City/Municipality (exact match)
                if (cityFilter && rock.location_name !== cityFilter) {
                    return false;
                }
                
                return true;
            });
        }
        
        // Render specimens based on current filters
        function renderFilteredSpecimens() {
            specimenLayer.clearLayers();
            const filteredSpecimens = getFilteredSpecimens();
            const markers = [];
            
            function getSpecimenColors(type) {
                const t = (type || '').toLowerCase();
                if (t.includes('metamorphic')) return { stroke: '#15803d', fill: '#16a34a' };   // green
                if (t.includes('sedimentary')) return { stroke: '#b91c1c', fill: '#dc2626' };   // red
                return { stroke: '#6a0dad', fill: '#9933cc' }; // igneous / default
            }
            
            filteredSpecimens.forEach(s => {
                const colors = getSpecimenColors(s.rock_type);
                const m = L.circleMarker([s.latitude, s.longitude], {
                    radius: 6,
                    color: colors.stroke,
                    weight: 2,
                    opacity: 1,
                    fillColor: colors.fill,
                    fillOpacity: 0.85
                })
                .bindPopup(
                    `Rock ID: <strong>${s.rock_id || s.sample_id}</strong>` +
                    `<br/>Rock Type: <strong>${s.rock_type || 'N/A'}</strong>` +
                    `<br/>Rock Formation: <strong>${s.formation || 'N/A'}</strong>` +
                    `<br/>Location: <strong>${s.location_name || 'Unknown'}</strong>` +
                    (s.latitude != null && s.longitude != null
                        ? `<br/>Coordinates: <strong>${parseFloat(s.latitude).toFixed(6)}, ${parseFloat(s.longitude).toFixed(6)}</strong>`
                        : '') +
                    (s.created_at ? `<br/>Date: <strong>${new Date(s.created_at).toLocaleString()}</strong>` : '') +
                    `<div class="map-popup-images">` +
                        `<div class="map-popup-image-block">` +
                            `<img class="map-popup-image" src="/image/sample/${s.sample_id}/rock_specimen" alt="Rock">` +
                            `<span>Specimen</span>` +
                        `</div>` +
                        `<div class="map-popup-image-block">` +
                            `<img class="map-popup-image" src="/image/sample/${s.sample_id}/outcrop" alt="Outcrop">` +
                            `<span>Outcrop</span>` +
                        `</div>` +
                    `</div>` +
                    `<br/><a href="/personnel/rock-detail/${s.sample_id}" class="link-primary">View details</a>`
                );
                m.addTo(specimenLayer);
                markers.push(m);
            });
            
            // Update count badge
            const countBadge = document.getElementById('specimen-count');
            if (countBadge) countBadge.textContent = filteredSpecimens.length;
            
            // Update location label
            const titleLabel = document.getElementById('selected-city-name');
            const cityFilter = document.getElementById('city-select')?.value || '';
            if (titleLabel) {
                titleLabel.textContent = cityFilter || 'All cities';
            }
            
            // Fit bounds to show all filtered markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                // If no markers, reset to default view
                map.setView([8.9475, 125.5406], 6);
            }
        }
        
        function renderAllSpecimens() {
            renderFilteredSpecimens();
        }
        
        function populateCityDropdown() {
            const select = document.getElementById('city-select');
            if (!select) return;
            select.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'All Cities';
            select.appendChild(placeholder);
            citiesData.slice().sort((a,b)=>a.location_name.localeCompare(b.location_name)).forEach(city => {
                const opt = document.createElement('option');
                opt.value = city.location_name;
                opt.textContent = `${city.location_name} (${city.specimen_count})`;
                select.appendChild(opt);
            });
            select.addEventListener('change', () => renderFilteredSpecimens());
        }
        
        // Setup filter event listeners
        function setupFilters() {
            const rockIdFilter = document.getElementById('rock-id-filter');
            const rockTypeFilter = document.getElementById('rock-type-filter');
            
            if (rockIdFilter) {
                rockIdFilter.addEventListener('input', debounce(() => renderFilteredSpecimens(), 300));
            }
            if (rockTypeFilter) {
                rockTypeFilter.addEventListener('change', () => renderFilteredSpecimens());
            }
        }
        
        // Debounce function for input fields
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Clear all filters
        window.clearAllFilters = function() {
            document.getElementById('rock-id-filter').value = '';
            document.getElementById('rock-type-filter').value = '';
            document.getElementById('city-select').value = '';
            renderFilteredSpecimens();
            }
        
        // Initialize map when DOM is ready
        console.log('DOM ready, initializing map...');
        initializeMap();
    });
</script>
{% endblock %}
